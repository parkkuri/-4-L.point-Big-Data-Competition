#??????Ʈ ???? ?????? ?ҷ??��?
shop<-read.table("purshopping.txt",header=T,sep=",")
shop<-shop[,c(1,3,4,6,9)]
shop<-subset(shop,BIZ_UNIT=='A02')
head(shop)
summary(shop) 

#?ߺ????? ?̷??? ?ִ? ȸ???? ???󳻾? ???? ???Ͽ? ????
shoplist<-shop[,c(1,3)]
head(shoplist)
a<-shop[which(duplicated(shoplist) | duplicated(shoplist, fromLast=T) ),]
dupshop<-a[c(order(a$ID,a$PD_S_C,a$DE_DT)),]
head(dupshop)
rownames(dupshop)<-NULL
write.table(dupshop,'C:/Users/ATIV/Documents/dupshop.txt',sep=",",row.names=FALSE)

#???ų?¥??�� ??¥?????? ??ȯ ?? ??¥???̰? ????�� ��?? df?? ?߰?
dupshop$DE_DT<-strptime(dupshop$DE_DT,"%Y%m%d")
head(dupshop)
df<-rep(0,nrow(dupshop))
dupshop<-cbind(dupshop,df)

#?? ?????? ��ǰ ???? ?? ?????? ��ǰ�� ?ߺ??????ϱ????? ?ɸ??? ?ð? ?????Ͽ? df???? ?Է?
for (i in 2:nrow(dupshop)){
  if (dupshop[i,3]==dupshop[i-1,3]){
    
      dupshop[i,'df']<-dupshop[i,4]-dupshop[i-1,4]
  }
}
head(dupshop,20)
write.table(dupshop,'C:/Users/ATIV/Documents/dupshop2.txt',sep=",",row.names=FALSE)

#?ǹ??ִ? ?ֱ⸸�� ????��?? ?????? ��ǰ�� 5ȸ ?̻? ?????? ?̷¸? ?񸮳??? df=0?? ?????ʹ? ��??
library(dplyr)
dupshop<-read.table("dupshop2.txt",header=T,sep=",")
head(dupshop,15)
dupshop.sum<-dupshop %>% group_by(ID,PD_S_C) %>% summarise(sumbuy=sum(BUY_CT))
dupshopa<-merge(dupshop.sum,dupshop,by.x=c('ID','PD_S_C'),by.y=c('ID','PD_S_C'))
dupshopb<-dupshopa[c(order(dupshopa$ID,dupshopa$PD_S_C,dupshopa$DE_DT)),]
dupshopc<-subset(dupshopb,sumbuy>=5)
dupshopd<-subset(dupshopc,df!=0)

#df?? ???հ? ?߾Ӱ? ???? ????
df.mean<-dupshopd %>% group_by(ID,PD_S_C) %>% summarise(df_mean=mean(df))
df.median<-dupshopd %>% group_by(ID,PD_S_C) %>% summarise(df_median=median(df))
head(df.mean,20)
head(df.median,20)

#?߾Ӱ?��?? ???? ????
subset(df.mean,ID==14296&PD_S_C==1444)
subset(df.median,ID==14296&PD_S_NM=='???Դ¿䱸??Ʈ')
subset(dupshop,ID==14296&PD_S_C==1444)

#?߾Ӱ?��?? ???? ?? ��?Ĺ?????, ??????????, ��??��???? ��??
df.median<-merge(df.median,dupshop.sum,by.x=c('ID','PD_S_C'),by.y=c('ID','PD_S_C'))
df.median<-subset(df.median,PD_S_C!=678&PD_S_C!=679&PD_S_C!=680)
df.mean<-subset(df.mean,PD_S_C!=678&PD_S_C!=679&PD_S_C!=680)
rownames(df.mean)<-NULL

#???ξ?��?з? ?????? ?ҷ??��?
shopclass<-read.csv('shopclass.csv',header=T)
head(shopclass)
shopclass<-subset(shopclass,BIZ_UNIT=='A02')
shopclass<-shopclass[,2:3]

#??????�� ��?? ??ǰ?ڵ带 ??ǰ??��?? ??ü ?? ???? ???Ϸ? ????
df.median.mer<-merge(df.median,shopclass,by.x='PD_S_C',by.y='PD_S_C')
df.median.mer<-df.median.mer[order(df.median.mer$ID),]
df.median<-df.median.mer[,c('ID','PD_S_NM','sumbuy','df_median')]
head(df.median,5)
write.table(df.median,'C:/Users/ATIV/Documents/df_median.txt',sep=",",row.names=FALSE)
